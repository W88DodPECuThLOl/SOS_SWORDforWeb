<!doctype html>
<html>
	<head>
		<meta charset=”UTF-8″>
		<title>S-OS"SWORD"</title>
		<script src="./js/sos/SOSWorkAddr.js"></script>
		<script src="./js/sos/SOSErrorCode.js"></script>
		<script src="./js/sos/SOSInfomationBlock.js"></script>
		<script src="./js/sos/SOS.js"></script>
		<script src="./js/sos/taskLineInput.js"></script>
		<script src="./js/sos/taskPlatformMonitor.js"></script>
		<script src="./js/sos/taskContext.js"></script>
		<script src="./js/z80Emu.js"></script>
		<script src="./js/taskMonitor.js"></script>
		<script src="./js/cat/catAudio.js"></script>
		<link rel="stylesheet" href="./css/catTextScreen.css">
	</head>
	<body>
		<input type="file" id="disk0" accept=".d88,.2D,.obj"/>
		<input type="checkbox" id="sound">Snd</input>
		<div class="canvas-wrapper">
			<canvas id="graphicCanvas" class="graphicsLayer"></canvas>
			<div id="sos_output" class="console"></div>
		</div>

		<script type="module">
			"use strict";

			// D88
			import Context from './js/HuBasic/HuBasic/Context.mjs';
			import HuBasicDisk from './js/HuBasic/HuBasic/HuBasicDisk.mjs';
			// SOS
			import CatKey from './js/cat/catKey.js';
			import CatTextScreen from './js/cat/catTextScreen.js';
			import CatGamePad from './js/cat/catGamePad.js';
			// グラフィック
			const graphicCanvas = document.getElementById("graphicCanvas");
			graphicCanvas.setAttribute("width", 640);
			graphicCanvas.setAttribute("height", 200);
			var graphicCanvasCtx = graphicCanvas.getContext("2d");
			// ディスクドライブ
			var disks = [
				new HuBasicDisk(new Context()),
				new HuBasicDisk(new Context()),
				new HuBasicDisk(new Context()),
				new HuBasicDisk(new Context())
			];

			var audio = new CatAudio();
			var gamePad = new CatGamePad(navigator);
			var z80Emu = new Z80Emu(audio, gamePad);
			var taskLineInput = new TaskLineInput();
			var taskMonitor = new TaskMonitor();
			var taskPlatformMonitor = new TaskPlatformMonitor();
			var catKey = new CatKey(document);
			var catTextScreen = new CatTextScreen(80,25);

			// URL Param
			// ?fnt=PC8001でPC8001風のフォントマップに
			// ?exec=実行したいファイルのURL
			const queryString = window.location.search;
			const urlParams = new URLSearchParams(queryString);
			const fontSet = urlParams.get('fnt');
			const execFile = urlParams.get('exec');
			const beepvol = urlParams.get('beepvol') ? parseFloat(urlParams.get('beepvol')) : 0.1;
			const beepfile = urlParams.get('beepfile') ? urlParams.get('beepfile') : './wav/X1BEEP.WAV';

			// BELL(BEEP)音
			var sound = new Audio(beepfile); // BEEPで再生する音声ファイル
			var catSnd = {
				/**
				 * ビープ音を再生する
				 */
				bell: ()=> {
					if(beepvol > 0.0) {
						sound.currentTime = 0; // 連続再生するときのおまじないらしい
						sound.volume = beepvol; // 音量
						sound.play();
					}
				}
			}

			// デフォルトのフォントを読み込む
			{
				const fontFace = new FontFace('defaultFont', 'url(./fonts/3/SMILEBASIC.ttf)');
				fontFace.load().then(function(loadedFace){
					// フォント読み込み成功
					document.fonts.add(loadedFace);
				}).catch(function(e){
					// フォント読み込み失敗
					console.error('フォントの読み込みに失敗しました');
				});
			}

			var ctx = new TaskContext(z80Emu, catKey, catTextScreen, taskLineInput, taskMonitor, taskPlatformMonitor, disks, catSnd, gamePad);
			// 初期のフォント設定
			if(fontSet) {
				ctx.changeFont(fontSet); // URLパラメータで設定されたフォント
			} else {
				ctx.changeFont("SOS"); // デフォルトのフォント
			}

			function diskSetup()
			{
				for(let i = 0; i < 1; i++) {
					const disk = document.getElementById('disk' + i);
					disk.addEventListener('change', evt => {
						let input = evt.target;
						if (input.files.length == 0) {
							disks[i].unmount();
							return;
						}
						const file = input.files[0];
						const reader = new FileReader();
						reader.onload = () => {
							const readData = new Uint8Array(reader.result);
							mountImage(i, file.name, readData);
						};
						reader.readAsArrayBuffer(file);
					});
				}
			}

			/**
			 * ディスクイメージをマウント、または、１個のファイルを実行する
			 * @param {number} deviceNo デバイス(0～3)
			 * @param {Uint8Array} readData イメージデータ
			 */
			function mountImage(deviceNo, filename, readData)
			{
				if(isSOSFileHeader(readData)) {
					// SOSのファイルヘッダあり
					const loadAddress = (ctx.hex(readData[0x8]) << 12) | (ctx.hex(readData[0x9]) << 8) | (ctx.hex(readData[0xA]) << 4) | ctx.hex(readData[0x0B]);
					const execAddress = (ctx.hex(readData[0xD]) << 12) | (ctx.hex(readData[0xE]) << 8) | (ctx.hex(readData[0xF]) << 4) | ctx.hex(readData[0x10]);
					const attribute   = (ctx.hex(readData[0x5]) <<  4) |  ctx.hex(readData[0x6]);
					if((attribute & 7) == 0x01) {
						// バイナリファイル
						ctx.memoryWrite(readData.subarray(18), loadAddress); // 読み込んで
						ctx.execCommand(execAddress); // 実行
					} else {
						// アスキーファイル
						alert("未対応の属性(FileMode)です。")
						return false;
					}
				} else if(isD88Image(readData)) {
					// D88のイメージ
					// ディスクをセットする
					disks[deviceNo].mount(filename, readData, false);
				} else if(is2dImage(filename, readData)) {
					// 2Dの生イメージ
					// ディスクをセットする
					disks[deviceNo].mount(filename, readData, true);
				} else {
					alert("不明なフォーマットタイプです。")
					return false;
				}
				return true;
			}

			function isSOSFileHeader(data)
			{
				// ファイルサイズで、判定
				if(data.length <= 18) { return false; }
				// ヘッダ部分で判定
				if(data[0x00] != 0x5F || data[0x01] != 0x53 || data[0x02] != 0x4F || data[0x03] != 0x53 || data[0x04] != 0x20) {
					return false;
				}
				// その他判定出来そうな所で
				if(data[0x07] != 0x20 || data[0x0C] != 0x20 || data[0x11] != 0x0A) {
					return false;
				}
				// 多分S-OSのヘッダ付きのファイル
				return true;
			}

			function is2dImage(filename, data)
			{
				// 2Dフォーマット時の標準的なファイルサイズで、判定
				if(data.length != 327680) { return false; }
				// イメージファイル名が2Dではないので違う
				if(!filename.endsWith(".2D") && !filename.endsWith(".2d")) { return false; }
				// OK
				return true;
			}
			function isD88Image(data)
			{
				// D88の2Dフォーマット時の標準的なファイルサイズで、判定
				if(data.length < 348848) { return false; }
				// リザーブエリアが0かどうかで判定
				for(let i = 0x11; i < 0x1A; ++i) {
					if(data[i] != 0x00) { return false; }
				}
				// プロテクトの設定が正しいかどうか
				if(data[0x1A] != 0x00 && data[0x1A] != 0x10) {
					return false;
				}
				// データサイズで判定
				const size = data[0x1C] | (data[0x1D] << 8) | (data[0x1E] << 16) | (data[0x1F] << 24);
				if(size != data.length) {
					return false;
				}
				// このぐらいでゆるしておく
				return true;
			}

			function update()
			{
				// ゲームパッドの更新
				gamePad.update();
				// Z80えみゅ
				z80Emu.update(ctx);
				// ライン入力
				taskLineInput.update(ctx);
				// モニタ
				taskMonitor.update(ctx);
				taskPlatformMonitor.update(ctx);
				// テキスト描画
				if(catTextScreen.isModified()) {
					document.getElementById("sos_output").innerHTML = catTextScreen.draw();
				}
				// グラフィック描画
				z80Emu.getVRAMImage(graphicCanvasCtx);
				// VSync待ち
				requestAnimationFrame(()=>update());
			}

			function autoStart() {
				const execFileReader = new XMLHttpRequest() ;
				//execFileReader.open("get", "./files/" + execFile, true) ;
				execFileReader.open("get", execFile, true) ;
				execFileReader.responseType = "arraybuffer" ;
				
				execFileReader.onerror = () => {
					alert("読み込み中にエラーが発生しました:" + execFile + "\nstatus:" + execFileReader.status);
				};
				execFileReader.onload = (evnt) => {
					if(execFileReader.status >= 400) {
						alert("読み込み中にエラーが発生しました:" + execFile + "\nstatus:" + execFileReader.status);
						return;
					}
					const objArray = execFileReader.response ;
					const objFile  = new Uint8Array(objArray) ;
					mountImage(0, execFile, objFile);
				}
				execFileReader.send() ;
			}
			
			// ページ読み込み後に実行される
			window.onload = async function() {
				// サウンド
				let psgBin = await (await fetch('./psg.wasm')).arrayBuffer();
				const soundOn = document.getElementById("sound");
				soundOn.addEventListener("change", ()=>{
					// サウンドの初期化
					audio.init(psgBin);
					// 多重初期化できないように消しちゃう
					soundOn.style.visibility = 'hidden';
				});

				// Z80エミュのセットアップ
				z80Emu.setup().then(
					(emu)=> {
						// ディスク
						diskSetup();
						// SOS
						ctx.reset();
						// auto staart
						if(execFile != null) {
							autoStart() ;
						}
						// 開始
						update();
					}
				);
			}
		</script>
	</body>
</html>