<!doctype html>
<html>
	<head>
		<meta charset=”UTF-8″>
		<title>S-OS"SWORD"</title>
		<script src="./js/sos/SOSWorkAddr.js"></script>
		<script src="./js/sos/SOSErrorCode.js"></script>
		<script src="./js/sos/SOSInfomationBlock.js"></script>
		<script src="./js/sos/SOS.js"></script>
		<script src="./js/sos/taskLineInput.js"></script>
		<script src="./js/sos/taskPlatformMonitor.js"></script>
		<script src="./js/sos/taskContext.js"></script>
		<script src="./js/z80Emu.js"></script>
		<script src="./js/taskMonitor.js"></script>
		<link rel="stylesheet" href="./css/catTextScreen.css">
	</head>
	<body>
		<input type="file" id="disk0" accept=".d88"/>
		<div class="canvas-wrapper">
			<canvas id="graphicCanvas" class="graphicsLayer"></canvas>
			<div id="sos_output" class="console"></div>
		</div>

		<script type="module">
			// D88
			import Context from './js/HuBasic/HuBasic/Context.mjs';
			import HuBasicDisk from './js/HuBasic/HuBasic/HuBasicDisk.mjs';
			// SOS
			import CatKey from './js/cat/catKey.js';
			import CatTextScreen from './js/cat/catTextScreen.js';
				// グラフィック
				const graphicCanvas = document.getElementById("graphicCanvas");
				graphicCanvas.setAttribute("width", 640);
				graphicCanvas.setAttribute("height", 200);
				var graphicCanvasCtx = graphicCanvas.getContext("2d");

			// ディスクドライブ
			var disks = [
				new HuBasicDisk(new Context()),
				new HuBasicDisk(new Context()),
				new HuBasicDisk(new Context()),
				new HuBasicDisk(new Context())
			];

			var z80Emu = new Z80Emu();
			var taskLineInput = new TaskLineInput();
			var taskMonitor = new TaskMonitor();
			var taskPlatformMonitor = new TaskPlatformMonitor();
			var catKey = new CatKey(document);
			var catTextScreen = new CatTextScreen(80,25);
			var catSnd = {
				/**
				 * ビープ音を再生する
				 */
				bell: ()=> {
					// @todo 探す
					// - フリーで、個人、商用利用とわず使用できること
					// - 短いこと ～300msぐらい？
					// - 8bit!
					// - 耳障りではないこと
					// - 個性的でないこと
					//const sound = new Audio('wav/bell.wav');
					//sound.play();
				}
			}


			// SMILEBASIC.ttf用の文字変換テーブル
			const tblMojiEncode = [
				/* 00 */ 0x0000, 0xE101, 0xE102, 0xE103, 0xE104, 0xE105, 0xE106, 0xE107,
				/* 08 */ 0x0008, 0xE109, 0xE10A, 0xE10B, 0x000C, 0x000D, 0xE10E, 0xE10F,
				/* 10 */ 0xE110, 0xE111, 0xE112, 0xE113, 0xE114, 0xE115, 0xE116, 0xE117,
				/* 18 */ 0xE118, 0xE119, 0xE11A, 0x001B, 0x001C, 0x001D, 0x001E, 0x001F,
				/* 20 */ 0x0020, 0x0021, 0x0022, 0x0023, 0x0024, 0x0025, 0x0026, 0x0027,
				/* 28 */ 0x0028, 0x0029, 0x002A, 0x002B, 0x002C, 0x002D, 0x002E, 0x002F,
				/* 30 */ 0x0030, 0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037,
				/* 38 */ 0x0038, 0x0039, 0x003A, 0x003B, 0x003C, 0x003D, 0x003E, 0x003F,
				/* 40 */ 0x0040, 0x0041, 0x0042, 0x0043, 0x0044, 0x0045, 0x0046, 0x0047,
				/* 48 */ 0x0048, 0x0049, 0x004A, 0x004B, 0x004C, 0x004D, 0x004E, 0x004F,
				/* 50 */ 0x0050, 0x0051, 0x0052, 0x0053, 0x0054, 0x0055, 0x0056, 0x0057,
				/* 58 */ 0x0058, 0x0059, 0x005A, 0x005B, 0x005C, 0x005D, 0x005E, 0x005F,
				/* 60 */ 0x0060, 0x0061, 0x0062, 0x0063, 0x0064, 0x0065, 0x0066, 0x0067,
				/* 68 */ 0x0068, 0x0069, 0x006A, 0x006B, 0x006C, 0x006D, 0x006E, 0x006F,
				/* 70 */ 0x0070, 0x0071, 0x0072, 0x0073, 0x0074, 0x0075, 0x0076, 0x0077,
				/* 78 */ 0x0078, 0x0079, 0x007A, 0xE2A8, 0x007C, 0xE2FF, 0x301C, 0x03C0,
				/* 80 */ 0xE2A1, 0xE2A2, 0xE2A3, 0xE2A4, 0xE2A5, 0xE2A6, 0xE2A7, 0xE2B1,
				/* 88 */ 0xE2AA, 0xE2AB, 0xE2AC, 0xE2AD, 0xE2AE, 0xE2AF, 0xE2B0, 0xE2FC,
				/* 90 */ 0xE295, 0xE296, 0xE290, 0xE291, 0xE294, 0xE292, 0xE293, 0xE299,
				/* 98 */ 0xE29B, 0xE29A, 0xE298, 0xE26C, 0xE26D, 0xE26E, 0xE26B, 0xE2FD, 
				/* A0 */ 0x3000, 0x3002, 0x300C, 0x300D, 0x3001, 0x30FB, 0x30F2, 0x30A1,
				/* A8 */ 0x30A3, 0x30A5, 0x30A7, 0x30A9, 0x30E3, 0x30E5, 0x30E7, 0x30C3, 
				/* B0 */ 0x30FC, 0x30A2, 0x30A4, 0x30A6, 0x30A8, 0x30AA, 0x30AB, 0x30AD,
				/* B8 */ 0x30AF, 0x30B1, 0x30B3, 0x30B5, 0x30B7, 0x30B9, 0x30BB, 0x30BD, 
				/* C0 */ 0x30BF, 0x30C1, 0x30C4, 0x30C6, 0x30C8, 0x30CA, 0x30CB, 0x30CC,
				/* C8 */ 0x30CD, 0x30CE, 0x30CF, 0x30D2, 0x30D5, 0x30D8, 0x30DB, 0x30DE,
				/* D0 */ 0x30DF, 0x30E0, 0x30E1, 0x30E2, 0x30E4, 0x30E6, 0x30E8, 0x30E9,
				/* D8 */ 0x30EA, 0x30EB, 0x30EC, 0x30ED, 0x30EF, 0x30F3, 0x309B, 0x309C,
				/* E0 */ 0x25CF, 0x25CB, 0x2660, 0x2665, 0x2666, 0x2663, 0xE29C, 0xE29D,
				/* E8 */ 0xE2FE, 0xE281, 0xE284, 0xE282, 0xE288, 0xE286, 0xE289, 0x25A1,
				/* F0 */ 0x203B, 0x571F, 0x91D1, 0x6728, 0x6C34, 0x706B, 0x6708, 0x65E5,
				/* F8 */ 0x6642, 0x5206, 0x79D2, 0x5E74, 0x5186, 0x4EBA, 0x751F, 0x3012
			];
			const tblMojiDecode = new Map();
			for(let i = 0; i < 0x100; i++) {
				tblMojiDecode.set(tblMojiEncode[i], i);
			}
			catTextScreen.setCodec(
				// 表示時
				(ch32)=>{
					if(!isNaN(Number(ch32))) {
						if(0x00 <= ch32 && ch32 <= 0xFF) { return tblMojiEncode[ch32]; }
					}
					return ch32;
				},
				// 取得時
				(ch32)=>{
					return tblMojiDecode.get(ch32);
					//if(tblMojiDecode.has(ch32)) { return tblMojiDecode.get(ch32); }
					//return ch32;
				}
			);
			var ctx = new TaskContext(z80Emu, catKey, catTextScreen, taskLineInput, taskMonitor, taskPlatformMonitor, disks, catSnd);
			function diskSetup()
			{
				for(let i = 0; i < 1; i++) {
					const disk = document.getElementById('disk' + i);
					disk.addEventListener('change', evt => {
						let input = evt.target;
						if (input.files.length == 0) {
							disks[i].unmount();
							return;
						}
						const file = input.files[0];
						const reader = new FileReader();
						reader.onload = () => {
							// ディスクをセット
							disks[i].mount(file.name, new Uint8Array(reader.result));
						};
						reader.readAsArrayBuffer(file);
					});
				}
			}

			function update()
			{
				// Z80えみゅ
				z80Emu.update(ctx);
				// ライン入力
				taskLineInput.update(ctx);
				// モニタ
				taskMonitor.update(ctx);
				taskPlatformMonitor.update(ctx);
				// テキスト描画
				if(catTextScreen.isModified()) {
					document.getElementById("sos_output").innerHTML = catTextScreen.draw();
				}
				// グラフィック描画
				z80Emu.getVRAMImage(graphicCanvasCtx);
				// VSync待ち
				requestAnimationFrame(()=>update());
			}

			// ページ読み込み後に実行される
			window.onload = function() {
				z80Emu.setup().then(
					(emu)=> {
						// ディスク
						diskSetup();
						// SOS
						ctx.reset();
						// 開始
						update();
					}
				);
			}
		</script>
	</body>
</html>