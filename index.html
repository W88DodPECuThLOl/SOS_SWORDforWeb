<!doctype html>
<html>
	<head>
		<meta charset=”UTF-8″>
		<title>S-OS"SWORD"</title>
		<script src="./js/sos/SOSWorkAddr.js"></script>
		<script src="./js/sos/SOSErrorCode.js"></script>
		<script src="./js/sos/SOSInfomationBlock.js"></script>
		<script src="./js/sos/SOS.js"></script>
		<script src="./js/sos/taskLineInput.js"></script>
		<script src="./js/sos/taskPlatformMonitor.js"></script>
		<script src="./js/sos/taskContext.js"></script>
		<script src="./js/z80Emu.js"></script>
		<script src="./js/taskMonitor.js"></script>
		<script src="./js/cat/catAudio.js"></script>
		<link rel="stylesheet" href="./css/catTextScreen.css">
	</head>
	<body>
		<input type="file" id="disk0" accept=".d88, .obj"/>
		<input type="checkbox" id="sound">Snd</input>
		<div class="canvas-wrapper">
			<canvas id="graphicCanvas" class="graphicsLayer"></canvas>
			<div id="sos_output" class="console"></div>
		</div>

		<script type="module">
			"use strict";

			// D88
			import Context from './js/HuBasic/HuBasic/Context.mjs';
			import HuBasicDisk from './js/HuBasic/HuBasic/HuBasicDisk.mjs';
			// SOS
			import CatKey from './js/cat/catKey.js';
			import CatTextScreen from './js/cat/catTextScreen.js';
			import CatGamePad from './js/cat/catGamePad.js';
			// グラフィック
			const graphicCanvas = document.getElementById("graphicCanvas");
			graphicCanvas.setAttribute("width", 640);
			graphicCanvas.setAttribute("height", 200);
			var graphicCanvasCtx = graphicCanvas.getContext("2d");
			// ディスクドライブ
			var disks = [
				new HuBasicDisk(new Context()),
				new HuBasicDisk(new Context()),
				new HuBasicDisk(new Context()),
				new HuBasicDisk(new Context())
			];

			var audio = new CatAudio();
			var gamePad = new CatGamePad(navigator);
			var z80Emu = new Z80Emu(audio, gamePad);
			var taskLineInput = new TaskLineInput();
			var taskMonitor = new TaskMonitor();
			var taskPlatformMonitor = new TaskPlatformMonitor();
			var catKey = new CatKey(document);
			var catTextScreen = new CatTextScreen(80,25);

			// URL Param
			// ?fnt=PC8001でPC8001風のフォントマップに
			const queryString = window.location.search;
			const urlParams = new URLSearchParams(queryString);
			const fontSet = urlParams.get('fnt');

			//var sound = new Audio('wav/X1BEEP.WAV'); // BEEPで再生する音声ファイル
			var catSnd = {
				/**
				 * ビープ音を再生する
				 */
				bell: ()=> {
					// @todo 探す
					// - フリーで、個人、商用利用とわず使用できること
					// - 短いこと ～300msぐらい？
					// - 8bit!
					// - 耳障りではないこと
					// - 個性的でないこと
					//sound.currentTime = 0; // 連続再生するときのおまじないらしい
					//sound.volume = 0.3; // 音量
					//sound.play();
				}
			}

			var ctx = new TaskContext(z80Emu, catKey, catTextScreen, taskLineInput, taskMonitor, taskPlatformMonitor, disks, catSnd, gamePad);
			if(fontSet == 'PC8001' || fontSet == 'PC8') {
				ctx.changeFont([0x50,0x43,0x38,0x00]); // フォントをPC8001風に
			} else {
				ctx.changeFont([0x53,0x4F,0x53,0x00]); // フォントをS-OS標準風に
			}
			function diskSetup()
			{
				for(let i = 0; i < 1; i++) {
					const disk = document.getElementById('disk' + i);
					disk.addEventListener('change', evt => {
						let input = evt.target;
						if (input.files.length == 0) {
							disks[i].unmount();
							return;
						}
						const file = input.files[0];
						const reader = new FileReader();
						reader.onload = () => {
							const readData = new Uint8Array(reader.result);
							if(isSOSFileHeader(readData)) {
								// SOSのファイルヘッダあり
								const loadAddress = (ctx.hex(readData[0x8]) << 12) | (ctx.hex(readData[0x9]) << 8) | (ctx.hex(readData[0xA]) << 4) | ctx.hex(readData[0x0B]);
								const execAddress = (ctx.hex(readData[0xD]) << 12) | (ctx.hex(readData[0xE]) << 8) | (ctx.hex(readData[0xF]) << 4) | ctx.hex(readData[0x10]);
								const attribute   = (ctx.hex(readData[0x5]) <<  4) |  ctx.hex(readData[0x6]);
								if((attribute & 7) == 0x01) {
									// バイナリファイル
									ctx.memoryWrite(readData.subarray(18), loadAddress); // 読み込んで
									ctx.execCommand(execAddress); // 実行
								} else {
									// アスキーファイル
									alert("未対応の属性(FileMode)です。")
								}
							} else if(isD88Image(readData)) {
								// D88イメージとする？
								// ディスクをセットする
								disks[i].mount(file.name, readData);
							} else {
								alert("不明なフォーマットタイプです。")
							}
						};
						reader.readAsArrayBuffer(file);
					});
				}
			}

			function isSOSFileHeader(data)
			{
				// ファイルサイズで、判定
				if(data.length <= 18) { return false; }
				// ヘッダ部分で判定
				if(data[0x00] != 0x5F || data[0x01] != 0x53 || data[0x02] != 0x4F || data[0x03] != 0x53 || data[0x04] != 0x20) {
					return false;
				}
				// その他判定出来そうな所で
				if(data[0x07] != 0x20 || data[0x0C] != 0x20 || data[0x11] != 0x0A) {
					return false;
				}
				// 多分S-OSのヘッダ付きのファイル
				return true;
			}

			function isD88Image(data)
			{
				// D88の2Dフォーマット時の標準的なファイルサイズで、判定
				if(data.length < 348848) { return false; }
				// リザーブエリアが0かどうかで判定
				for(let i = 0x11; i < 0x1A; ++i) {
					if(data[i] != 0x00) { return false; }
				}
				// プロテクトの設定が正しいかどうか
				if(data[0x1A] != 0x00 && data[0x1A] != 0x10) {
					return false;
				}
				// データサイズで判定
				const size = data[0x1C] | (data[0x1D] << 8) | (data[0x1E] << 16) | (data[0x1F] << 24);
				if(size != data.length) {
					return false;
				}
				// このぐらいでゆるしておく
				return true;
			}

			function update()
			{
				// ゲームパッドの更新
				gamePad.update();
				// Z80えみゅ
				z80Emu.update(ctx);
				// ライン入力
				taskLineInput.update(ctx);
				// モニタ
				taskMonitor.update(ctx);
				taskPlatformMonitor.update(ctx);
				// テキスト描画
				if(catTextScreen.isModified()) {
					document.getElementById("sos_output").innerHTML = catTextScreen.draw();
				}
				// グラフィック描画
				z80Emu.getVRAMImage(graphicCanvasCtx);
				// VSync待ち
				requestAnimationFrame(()=>update());
			}

			// ページ読み込み後に実行される
			window.onload = async function() {
				// サウンド
				let psgBin = await (await fetch('./psg.wasm')).arrayBuffer();
				const soundOn = document.getElementById("sound");
				soundOn.addEventListener("change", ()=>{
					// サウンドの初期化
					audio.init(psgBin);
					// 多重初期化できないように消しちゃう
					soundOn.style.visibility = 'hidden';
				});

				// Z80エミュのセットアップ
				z80Emu.setup().then(
					(emu)=> {
						// ディスク
						diskSetup();
						// SOS
						ctx.reset();
						// 開始
						update();
					}
				);
			}
		</script>
	</body>
</html>